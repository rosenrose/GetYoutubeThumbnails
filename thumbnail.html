<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <style>
        #urlInput {
            width: 20em;
        }
        #response {
            white-space: pre-wrap;
        }
        #single {
            margin: 10px 0;
        }
        #multi {
            display: none;
        }
        
        .nav {
            display: none;
            text-align: center;
        }
        .item {
            display: inline-block;
            margin: 5px;
            max-width: 32.8%;
        }
        .item img {
            width: 100%;
        }
        .pagePos {
            display: inline;
        }
        .pageInput {
            width: 2em;
            background-color: #fff;
        }
    </style>
</head>
<body>
    <input type="text" id="urlInput" placeholder="Enter video id or playlist id or url"><button type="button" id="urlInputBtn">input</button>
    <p id="requestUrl"></p>
    <img src="" id="single">
    <div id="multi">
        <div class="nav">
            <button type="button" class="prev">Prev</button>
            <p class="pagePos"></p>
            <input type="text" class="pageInput" inputmode="numeric" pattern="[0-9]*"><button type="button" class="go">Go</button>
            <button type="button" class="next">Next</button>
        </div>
        <div id="itemContainer"></div>
        <div class="nav">
            <button type="button" class="prev">Prev</button>
            <p class="pagePos"></p>
            <input type="text" class="pageInput" inputmode="numeric" pattern="[0-9]*"><button type="button" class="go">Go</button>
            <button type="button" class="next">Next</button>
        </div>
    </div>
    <pre id="response"></pre>
    <script>
        const maxResults = 12;
        videoRegex = /(?<=(watch\?v=|youtu.be\/)?)[\w\-]{11}/;
        playlistRegex = /(?<=(playlist\?list=)?)[\w\-]{34,}/;
        auth = yourapikey // See https://developers.google.com/youtube/v3/getting-started
        
        document.querySelector("#urlInputBtn").addEventListener("click", event => {
            let input = document.querySelector("#urlInput").value;
            if (result = playlistRegex.exec(input)) {
                api = `https://www.googleapis.com/youtube/v3/playlistItems?playlistId=${result[0]}&key=${auth}&part=snippet&maxResults=${maxResults}`;
            }
            else if (result = videoRegex.exec(input)) {
                api = `https://www.googleapis.com/youtube/v3/videos?id=${result[0]}&key=${auth}&part=snippet`;
            }
            getData(api);
        });

        function getData(url) {
            fetch(url)
            .then(response => response.json())
            .then(content => {
                document.querySelector("#requestUrl").textContent = url;
                document.querySelector("#response").textContent = JSON.stringify(content,null,2);
                let videos = content.items;
                if (videos.length == 1) {
                    document.querySelector("#single").src = getMax(videos[0]).url;
                }
                else {
                    setContent(videos);
                    if (content.nextPageToken) {
                        pos = 1;
                        toggleDisplay(pos > 1, "inline", ...document.querySelectorAll(".prev"));
                        totalPages = Math.ceil(content.pageInfo.totalResults/content.pageInfo.resultsPerPage);
                        document.querySelectorAll(".pagePos").forEach(p => {p.textContent = `${pos}/${totalPages}`;});
                        pages = [[content,url]];
                        paginate(content, 1);
                    }
                }
                toggleDisplay(videos.length == 1, "block", document.querySelector("#single"));
                toggleDisplay(videos.length > 1, "block", document.querySelector("#multi"));
                toggleDisplay(content.nextPageToken, "block", ...document.querySelectorAll(".nav"));
            });
        }

        function setContent(videos) {
            let itemContainer = document.querySelector("#itemContainer");
            while (itemContainer.hasChildNodes()) {
                itemContainer.firstChild.remove();
            }
            for (let video of videos) {
                let item = document.createElement("div");
                item.className = "item";
                let item_image_link = document.createElement("a");
                item_image_link.href = getMax(video).url;
                item_image_link.target = "_blank";
                let item_image = document.createElement("img");
                item_image.src = getMax(video).url;
                let item_title = document.createElement("a");
                item_title.href = "https://youtu.be/"+video.snippet.resourceId.videoId;
                item_title.target = "_blank";
                item_title.textContent = video.snippet.title;
                
                item_image_link.appendChild(item_image);
                item.appendChild(item_image_link);
                item.appendChild(item_title);
                itemContainer.appendChild(item);
            }
        }

        function paginate(content, iter) {
            if(content.nextPageToken) {
                let request = `${api}&pageToken=${content.nextPageToken}`;
                fetch(request)
                .then(response => response.json())
                .then(json => {
                    pages.push([json, request]);
                    if (json.nextPageToken) {
                        paginate(json, iter+1);
                    }
                    else {
                        pos = 1;
                        document.querySelector("#requestUrl").textContent = api;
                    }
                });
                document.querySelector("#requestUrl").textContent = `Getting playlists... ${iter}/${totalPages}`;
            }
        }

        document.querySelectorAll(".nav button").forEach(btn => {
            btn.addEventListener("click", event => {
                switch (event.target.className) {
                    case "next":
                        if (pos < pages.length) {
                            pos += 1;
                        }
                        break;
                    case "prev":
                        if (pos > 1) {
                            pos -= 1;
                        }
                        break;
                    case "go":
                        let temp = parseInt(event.target.previousElementSibling.value);
                        if (temp >= 1 && temp <= pages.length) {
                            pos = temp;
                        }
                        break;
                }
                setContent(pages[pos-1][0].items);
                document.querySelector("#requestUrl").textContent = pages[pos-1][1];
                document.querySelectorAll(".pagePos").forEach(p => {p.textContent = `${pos}/${totalPages}`;});
                document.querySelector("#response").textContent = JSON.stringify(pages[pos-1][0],null,2);
                toggleDisplay(pos < pages.length, "inline", ...document.querySelectorAll(".next"));
                toggleDisplay(pos > 1, "inline", ...document.querySelectorAll(".prev"));
            });
        });

        document.addEventListener("keydown", event => {
            if (document.querySelector(".nav").style.display != "none") {
                switch (event.key) {
                    case "ArrowLeft":
                        document.querySelector(".prev").click();
                        break;
                    case "ArrowRight":
                        document.querySelector(".next").click();
                        break;
                }
            }
        });

        function getMax(video) {
            let thumbnail = video.snippet.thumbnails;
            if (thumbnail) {
                let keys = Object.keys(thumbnail);
                if (keys.length) {
                    return thumbnail[keys[keys.length-1]];
                }
                else {
                    return {url: ""};    
                }
            }
            else {
                return {url: ""};
            }
        }

        function toggleDisplay(condition, display, ...elems) {
            elems.forEach(elem => {
                elem.style.display = (condition)? display : "none";
            })
        }
    </script>
</body>
</html>
