<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <style>
        #urlInput {
            width: 20em;
        }
        #response {
            white-space: pre-wrap;
        }
        #single {
            margin: 10px 0;
        }

        .nav {
            text-align: center;
        }
        .item {
            display: inline-block;
            margin: 0.2em;
            margin-bottom: 0.7em;
            width: 32.8%;
        }
        .item img {
            width: 100%;
        }
        .pagePos {
            display: inline;
        }
        .pageInput {
            width: 2em;
            background-color: #fff;
        }
    </style>
</head>
<body>
    <input type="text" id="urlInput" placeholder="Enter video id or playlist id or url"><button type="button" id="urlInputBtn">input</button>
    <div id="single">
        <a id="maxres" href="" target="_blank">
            <img src="">
        </a>
    </div>
    <div id="multi" hidden>
        <div class="nav">
            <button type="button" class="prev">Prev</button>
            <p class="pagePos"></p>
            <input type="text" class="pageInput" inputmode="numeric" pattern="[0-9]*"><button type="button" class="go">Go</button>
            <button type="button" class="next">Next</button>
        </div>
        <div id="itemContainer"></div>
        <div class="nav" hidden>
            <button type="button" class="prev">Prev</button>
            <p class="pagePos"></p>
            <input type="text" class="pageInput" inputmode="numeric" pattern="[0-9]*"><button type="button" class="go">Go</button>
            <button type="button" class="next">Next</button>
        </div>
    </div>
    <p id="responseUrl"></p>
    <pre id="response"></pre>
    <template id="itemTemplate">
        <figure class="item">
            <a href="" target="_blank">
                <img src="">
            </a>
            <figcaption>
                <a href="" target="_blank"></a>
            </figcaption>
        </figure>
    </template>
    <script>
        const maxResults = 12;
        videoRegex = /(?<=(watch\?v=|youtu.be\/)?)[\w\-]{11}/;
        playlistRegex = /(?<=(playlist\?list=)?)[\w\-]{34,}/;
        auth = yourapikey; // See https://developers.google.com/youtube/v3/getting-started

        document.querySelector("#urlInputBtn").addEventListener("click", event => {
            let input = document.querySelector("#urlInput").value;
            if (result = playlistRegex.exec(input)) {
                api = `https://www.googleapis.com/youtube/v3/playlistItems?playlistId=${result[0]}&key=${auth}&part=snippet,contentDetails&maxResults=${maxResults}`;
            }
            else if (result = videoRegex.exec(input)) {
                api = `https://www.googleapis.com/youtube/v3/videos?id=${result[0]}&key=${auth}&part=snippet,contentDetails`;
            }
            getData(api);
        });

        function getData(url) {
            fetch(url)
            .then(response => response.json())
            .then(content => {
                document.querySelector("#responseUrl").textContent = url;
                document.querySelector("#response").textContent = JSON.stringify(content, null, 2);

                let videos = content.items;
                if (videos.length == 1) {
                    document.querySelector("#maxres").href = getMax(videos[0]).url;
                    document.querySelector("#maxres img").src = getMax(videos[0]).url;
                }
                else {
                    setContent(videos);
                    if (content.nextPageToken) {
                        pos = 1;
                        toggleDisplay(pos > 1, ...document.querySelectorAll(".prev"));
                        totalPages = Math.ceil(content.pageInfo.totalResults / content.pageInfo.resultsPerPage);
                        document.querySelectorAll(".pagePos").forEach(p => {p.textContent = `${pos}/${totalPages}`;});
                        pages = [[content,url]];
                        paginate(content);
                    }
                }
                selectDisplay(`#${(videos.length == 1)? "single" : "multi"}`, ...document.querySelectorAll("#single, #multi"));
                toggleDisplay(content.nextPageToken, ...document.querySelectorAll(".nav"));
            });
        }

        function setContent(videos) {
            let itemContainer = document.querySelector("#itemContainer");
            itemContainer.replaceChildren();
            for (let video of videos) {
                let template = document.querySelector("#itemTemplate").content.cloneNode(true);

                let item_image_link = template.querySelector("a");
                item_image_link.href = getMax(video).url;
                let item_image = template.querySelector("img");
                item_image.src = getMax(video).url;
                let item_title = template.querySelector("figcaption a");
                item_title.href = `https://youtu.be/${video.snippet.resourceId.videoId}`;
                item_title.textContent = video.snippet.title;

                itemContainer.append(template.firstElementChild);
            }
        }

        async function paginate(content) {
            let json = content;

            for (let i = 1; json.nextPageToken; i++) {
                let request = `${api}&pageToken=${json.nextPageToken}`;
                json = await (await fetch(request)).json();
                pages.push([json, request]);
                document.querySelector("#responseUrl").textContent = `Getting playlists... ${i}/${totalPages}`;
            }
            document.querySelector("#responseUrl").textContent = api;
        }

        document.querySelectorAll(".nav button").forEach(btn => {
            btn.addEventListener("click", event => {
                switch (event.target.className) {
                    case "next":
                        if (pos < pages.length) {
                            pos += 1;
                        }
                        break;
                    case "prev":
                        if (pos > 1) {
                            pos -= 1;
                        }
                        break;
                    case "go":
                        let go = parseInt(event.target.previousElementSibling.value);
                        if (go >= 1 && go <= pages.length) {
                            pos = go;
                        }
                        break;
                }
                setContent(pages[pos-1][0].items);
                document.querySelector("#responseUrl").textContent = pages[pos-1][1];
                document.querySelectorAll(".pagePos").forEach(p => {p.textContent = `${pos}/${totalPages}`;});
                document.querySelector("#response").textContent = JSON.stringify(pages[pos-1][0],null,2);
                toggleDisplay(pos < pages.length, ...document.querySelectorAll(".next"));
                toggleDisplay(pos > 1, ...document.querySelectorAll(".prev"));
            });
        });

        document.addEventListener("keydown", event => {
            if (document.querySelector(".nav").style.display != "none") {
                switch (event.key) {
                    case "ArrowLeft":
                        document.querySelector(".prev").click();
                        break;
                    case "ArrowRight":
                        document.querySelector(".next").click();
                        break;
                }
            }
        });

        function getMax(video) {
            let thumbnail = video.snippet.thumbnails;
            if (thumbnail) {
                let keys = Object.keys(thumbnail);
                //maxresdefault sddefault hqdefault mqdefault default
                if (keys.length) {
                    return thumbnail[keys.at(-1)];
                }
                return {url: ""};
            }
            return {url: ""};
        }

        function toggleDisplay(condition, ...element) {
            element.forEach(elem => {
                elem.hidden = !condition;
            });
        }
        function selectDisplay(query, ...element) {
            element.forEach(elem => {
                elem.style.display = elem.matches(query)? "" : "none";
            });
            element.forEach(elem => {
                elem.hidden = !elem.matches(query);
            });
        }
        
        if (!Array.prototype.at) {
            Array.prototype.at = function (index) {
                if (isNaN(index)) {
                    return undefined;
                }

                index = parseInt(index);

                if (index < 0) {
                    index += this.length;
                }

                return this[index];
            }
        }
    </script>
</body>
</html>
